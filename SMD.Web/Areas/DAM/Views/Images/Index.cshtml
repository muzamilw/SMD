@{
    ViewBag.Title = "Manage Images";
    Layout = null;

}

@model SMD.MIS.Areas.DAM.Models.ImagesModel
<link href="~/content/dam/damsite.css" rel="stylesheet" />
<link href="~/Content/themes/Centaurus/css/bootstrap/bootstrap.min.css" rel="stylesheet" />

<section id="main" style="display:none;">
    <div class="row">

        <div class="row" style="padding-left:0px;min-height:400px;">
            <div class="pull-left damImgContainer" style="width:35%;overflow:auto;height:600px;overflow-x: hidden; ">
                @if (Model != null && Model.Images.Count > 0)
                {
                    <div class="imageContainer">
                        @foreach (var img in Model.Images)
                        {
                            <div class="imageBox" id="@img.ImageId">
                                <img src="@img.ImageFileName" alt="Image" class="imagePreview" />
                                <input type="hidden" value="@img.ImageTitle" class="title" />

                                <div class="imageBoxName">
                                <a class="" onclick="deletedImage(@img.ImageId)" style="float: right;">
                                    <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                                </a></div>
                                
                            </div>

                        }
                    </div>
                }
                else
                {
                    <div class="imageCenter">
                        No images have been uploaded so far.
                    </div>
                }
            </div>
            <div class=" pull-left" style="width:63%">
                <div id="tabs" style=" border: none;">
                    <ul>
                        <li><a href="#tabs-1">Upload Image</a></li>
                        <li><a href="#tabs-2">Free Images</a></li>
                    </ul>
                    <div id="tabs-1">
                        @using (Html.BeginForm("UploadImage", "Images", FormMethod.Post, new { enctype = "multipart/form-data" }))
                        {
                            @Html.HiddenFor(model => model.X)
                            @Html.HiddenFor(model => model.Y)
                            @Html.HiddenFor(model => model.Width)
                            @Html.HiddenFor(model => model.Height)
                            @Html.HiddenFor(model => model.CompanyId)
                            @Html.HiddenFor(model => model.mode)
                            @Html.HiddenFor(model => model.bytes)
                            <div>
                                <div class="editor-row" style="">

                                    @*<div id="lblOr" >-OR-</div>*@
                                    <button class="btn  btn-success " id="uploadFileMain" style="width:30%;margin-bottom:4px;    margin-left: 12px;">Upload an Image</button>
                                </div>
                                <div class="image-editor">

                                    <div style="margin-bottom:60px;margin-left:30px;margin-right:20px;">Your uploaded image must be greater than minimum size of (<b><span id="spansizestring"></span></b>). You can pan/zoom your bigger images and crop them to requied size below.</div>
                                    <input type="file" class="cropit-image-input" style="display:none;">
                                    <div class="cropit-preview"></div>
                                    <div class="controls-wrapper">
                                        <div class="slider-wrapper">
                                            <span class="icon icon-image small-image"></span>
                                            <input type="range" class="cropit-image-zoom-input" min="0" max="1" step="0.01">
                                            <span class="icon icon-image large-image"></span>
                                        </div>
                                    </div>
                                    <button class="btn  btn-info  export" id="changeCategory" style="width: 121px;"> Crop & Save</button>
                                    <button class="btn  btn-yellow  export" id="cancelCategory" style="width: 121px;"> Cancel</button>
                                </div>

                            </div>
                        }
                    </div>
                    <div id="tabs-2">
                        @if (Model != null && Model.FreeImages.Count > 0)
                        {
                            <div class="imageContainer">
                                @foreach (var img in Model.FreeImages)
                                {
                                    <div class="imageBox" id="@img.ImageId" style="margin-left:0px;">
                                        <img src="@img.ImageFileName" alt="Image" class="imagePreview imageFreePreview" />
                                        <input type="hidden" value="@img.ImageTitle" class="title" />
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="imageCenter">
                                No  Free images have been uploaded so far.
                            </div>
                        }
                    </div>
                   
                </div>


            </div>

        </div>

        <button style="display:none" id="loadModel" data-toggle="modal" data-target="#damImageEditor"></button>

    </div>

</section>
<section id="loader" >
    <img src="~/Content/DAM/Preloader_3.gif"  style=" margin-top: 14%; margin-left: 44%;"/>
</section>



@section Scripts{
   


}


<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
<script src="~/Content/DAM/jquery-ui.js"></script>
<link href="~/Content/DAM/jquery-ui.css" rel="stylesheet" />
<script src="~/Content/DAM/cropit.js"></script>
<script src="~/Scripts/bootstrap.min.js"></script>
<script>
    var aspectRatio = "2:1", minheight = 200, minWidth = 400;
    var imgDataUrl = "";
    $(window).load(function() {
        $("#main").css("display","block");
        $("#loader").css("display","none");
    });
    $(document).ready(function () {
        var mode = GetURLParameter("mode");
        var sizeString = "";
        
        var ratioX = 2, ratioY = 1;
        if (mode == 1) {
            aspectRatio = "2:1";
            minheight = 150;
            minWidth = 300
        }
        else if (mode == 2) {
            aspectRatio = "2:1";
            minheight = 200;
            minWidth = 400
        } else if (mode == 3) {
            aspectRatio = "8:5";
            minheight = 250;
            minWidth = 400
        } else if (mode == 4) {
            minheight = 400;
            minWidth = 200
            aspectRatio = "1:2";
        }
        var sizeString = ''+ minWidth + ' x ' + minheight;
        $("#spansizestring").text(sizeString);
        $(".cropit-preview").css("width", minWidth + "px");
        $(".cropit-preview").css("height", minheight + "px");
        $('.cropit-image-input').change(function (evt) {
            $(".image-editor").css("display", "block");
        });
        $('.imageFreePreview').click(function (evt) {
            $(".image-editor").css("display", "block");
            $('.image-editor').cropit('imageSrc', this.src);

            $(".cropit-preview").attr("src",this.src);
            $( "#tabs" ).tabs({ active: 0});
        });
        
        $("#uploadFileMain").click(function () {
            $('.cropit-image-input').click();
            return false;
        });
        $("#cancelCategory").click(function () {
            $('.image-editor').css("display", "none");
            $(".cropit-image-input").val('');
            return false;
        });
        $(function () {
            $("#tabs").tabs();
        });
    });
    function GetURLParameter(sParam)
    {
        var sPageURL = window.location.search.substring(1);
        var sURLVariables = sPageURL.split('&');
        for (var i = 0; i < sURLVariables.length; i++) 
        {
            var sParameterName = sURLVariables[i].split('=');
            if (sParameterName[0] == sParam) 
            {
                return sParameterName[1];
            }
        }
        return 0;
    }
   
    function showProgress() {

    }
    function hideProgress() {

    }
    function deletedImage(selectedImgId) {
        var r = confirm("Are you sure you want to delete this image?");
        if (r == true) {
            var model = {
                imageId: selectedImgId
            }
            var jsonObjects = JSON.stringify(model, null, 2);
            var to;
            to = "/DAMImages/DeleteImage/";
            var options = {
                type: "POST",
                url: to,
                data: jsonObjects,
                contentType: "application/json",
                async: true,
                success: function (response) {
                    window.location.href = "/DamImages?mode="+$("#mode").val()
                },
                error: function (msg) {
                    alert("Error occured "); console.log(msg);
                }
            };
            var returnText = $.ajax(options).responseText;
        } else {
           
        }
       
    }
    //function getDataURL(result) {
    //    var canvas = document.createElement('canvas'), ctx = canvas.getContext('2d');
    //    canvas.width = result.options.width;
    //    canvas.height = result.options.height;
    //    ctx.drawImage(result.$image.get(0), result.result.cropX, result.result.cropY, result.result.cropW, result.result.cropH, 0, 0, result.options.width, result.options.height);
    //    return canvas.toDataURL();
    //}
    window.onload = function () {
        try {
            parent.iframeLoaded();
        } catch (e) {

        }
        
    }

</script>
<script>
    $(function () {
        $('.image-editor').cropit({
            imageState: {
                src: '/content/images/placeholder.png',
            },
            imageBackground: true,
            imageBackgroundBorderWidth: 40,
        });

        $('.export').click(function () {
            var imageData = $('.image-editor').cropit('export');
            $("#bytes").val(imageData);
           // window.open(imageData);
        });
    });
</script>